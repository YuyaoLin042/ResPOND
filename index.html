<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ResPOND BLE Connect</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      background: linear-gradient(to bottom, #1a4e48, #40897f);
      color: #fff;
      overflow: hidden;
    }
    #ui {
      position: absolute;
      top: 20px;
      left: 30px;
    }
    #ui h1 {
      margin: 0;
      font-size: 24px;
    }
    #ui p {
      margin: 5px 0;
      font-size: 14px;
    }
    #buttons {
      position: absolute;
      top: 20px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 20px;
      background: #4e5cf5;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h1>ResPOND</h1>
    <p id="status">Status: Not connected</p>
    <p id="point-count">Connected Points: 0</p>
    <p id="motor-count">Motor Trigger Count: 0</p>
  </div>
  <div id="buttons">
    <button onclick="connectDevice()">Connect Device</button>
    <button onclick="disconnectDevice()">Disconnect Device</button>
  </div>

  <script>
    let device;
    let characteristic;
    let connectedPoints = 0;
    let motorTriggerCount = 0;

    async function connectDevice() {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ namePrefix: 'Bluno' }],
          optionalServices: ['dfb0']
        });

        const server = await device.gatt.connect();
        document.getElementById('status').textContent = 'Status: Connected';

        const service = await server.getPrimaryService('dfb0');
        characteristic = await service.getCharacteristic('dfb1');

        await characteristic.startNotifications();
        characteristic.addEventListener('characteristicvaluechanged', handleData);

        connectedPoints = 1;
        document.getElementById('point-count').textContent = `Connected Points: ${connectedPoints}`;
      } catch (error) {
        console.error('Bluetooth connection failed:', error);
        alert('Bluetooth connection failed. Check console for details.');
      }
    }

    function disconnectDevice() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
        document.getElementById('status').textContent = 'Status: Disconnected';
        connectedPoints = 0;
        document.getElementById('point-count').textContent = `Connected Points: ${connectedPoints}`;
      }
    }

    function handleData(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const data = decoder.decode(value);
      console.log('Received data:', data);

      // Example logic: count motor triggers
      if (data.includes('MOTOR_TRIGGER')) {
        motorTriggerCount++;
        document.getElementById('motor-count').textContent = `Motor Trigger Count: ${motorTriggerCount}`;
      }
    }
  </script>
</body>
</html>
