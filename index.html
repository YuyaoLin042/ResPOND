<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ResPOND BLE Ripples</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Calibri', sans-serif;
      background: linear-gradient(to bottom, #1a4e48, #40897f);
      color: #fff;
    }
    canvas {
      display: block;
    }
    #ui {
      position: absolute;
      top: 20px;
      left: 30px;
      z-index: 10;
    }
    #ui h1 {
      font-size: 28px;
      margin: 0;
      font-weight: bold;
    }
    #ui p {
      font-size: 14px;
      margin: 4px 0;
    }
    #buttons {
      position: absolute;
      top: 20px;
      right: 30px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      background-color: #4e5cf5;
      color: white;
      border: none;
      padding: 10px 16px;
      font-size: 14px;
      border-radius: 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="ui">
    <h1>ResPOND</h1>
    <p>Sense, Respond, Empower</p>
    <p id="point-count">Connected Points: 0</p>
    <p id="motor-count">Motor Trigger Count: 0</p>
  </div>
  <div id="buttons">
    <button id="bleButton">Connect Device</button>
    <button id="fullscreenButton">Fullscreen</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.2/p5.min.js"></script>
  <script>
    let wavePhase = 0;
    let ripples = [], pellets = [], bubbles = [];
    let motorTriggerCount = 0, connectedPoints = 0;
    let bleDevice = null, bleCharacteristic = null;

    document.getElementById('bleButton').addEventListener('click', async () => {
      if (!bleDevice) {
        try {
          bleDevice = await navigator.bluetooth.requestDevice({
            filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
          });
          const server = await bleDevice.gatt.connect();
          const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
          bleCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
          await bleCharacteristic.startNotifications();
          bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);
          connectedPoints = 1;
          document.getElementById('point-count').textContent = `Connected Points: ${connectedPoints}`;
          document.getElementById('bleButton').textContent = 'Disconnect Device';
        } catch (err) {
          alert('Connection failed: ' + err);
        }
      } else {
        if (bleDevice.gatt.connected) bleDevice.gatt.disconnect();
        bleDevice = null;
        bleCharacteristic = null;
        connectedPoints = 0;
        document.getElementById('point-count').textContent = 'Connected Points: 0';
        document.getElementById('bleButton').textContent = 'Connect Device';
      }
    });

    document.getElementById('fullscreenButton').addEventListener('click', () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen();
        document.getElementById('fullscreenButton').textContent = 'Exit Fullscreen';
      } else {
        document.exitFullscreen();
        document.getElementById('fullscreenButton').textContent = 'Fullscreen';
      }
    });

    function handleData(event) {
      const value = new TextDecoder().decode(event.target.value).trim();
      const parts = value.split(',');
      if (parts.length === 5) {
        const reference = parseFloat(parts[0]);
        const f1 = parseFloat(parts[1]);
        const f2 = parseFloat(parts[2]);
        const f3 = parseFloat(parts[3]);
        const vib = parseFloat(parts[4]);

        let mismatch = 0;
        if (Math.abs(f1 - reference) > 4) mismatch++;
        if (Math.abs(f2 - reference) > 4) mismatch++;
        if (Math.abs(f3 - reference) > 4) mismatch++;

        if (mismatch >= 2 && vib > 20) {
          motorTriggerCount++;
          document.getElementById('motor-count').textContent = `Motor Trigger Count: ${motorTriggerCount}`;
          pellets.push(new Pellet(random(width)));
        }
      }
    }

    function setup() {
      createCanvas(windowWidth, windowHeight);
    }

    function draw() {
      background(26, 78, 72);
      drawWaves();

      for (let i = ripples.length - 1; i >= 0; i--) {
        ripples[i].update();
        ripples[i].display();
        if (ripples[i].isDone()) ripples.splice(i, 1);
      }

      for (let i = pellets.length - 1; i >= 0; i--) {
        pellets[i].update();
        pellets[i].display();
        if (pellets[i].hitWater) {
          for (let j = 0; j < 2; j++) {
            bubbles.push(new Bubble(pellets[i].pos.x, height * 0.65));
            bubbles.push(new Bubble(pellets[i].pos.x, height * 0.45));
          }
        }
        if (pellets[i].isDone()) pellets.splice(i, 1);
      }

      for (let i = bubbles.length - 1; i >= 0; i--) {
        bubbles[i].update();
        bubbles[i].display();
        if (bubbles[i].isDone()) bubbles.splice(i, 1);
      }
    }

    function drawWaves() {
      noStroke();
      fill(255, 255, 255, 30);
      for (let x = 0; x < width; x += 10) {
        for (let y = 0; y < 30; y++) {
          let yy = height * 0.35 + 8 * sin(x * 0.01 + wavePhase + y * 0.2);
          let alpha = map(y, 0, 29, 80, 10);
          fill(255, alpha);
          ellipse(x, yy + y * 6, 4 - y * 0.08);
        }
      }
      wavePhase += 0.01;
    }

    class Pellet {
      constructor(x) {
        this.pos = createVector(x, -20);
        this.hitWater = false;
        this.alpha = 255;
      }
      update() {
        if (!this.hitWater) this.pos.y += 1.2;
        else this.alpha -= 2;
        if (this.pos.y > height * 0.35) this.hitWater = true;
      }
      display() {
        fill(255, this.alpha);
        noStroke();
        ellipse(this.pos.x, this.pos.y, 6, 6);
      }
      isDone() {
        return this.alpha <= 0;
      }
    }

    class Bubble {
      constructor(x, y) {
        this.pos = createVector(x, y);
        this.size = random(3, 8);
        this.speed = random(0.3, 0.8);
        this.alpha = 150;
      }
      update() {
        this.pos.y -= this.speed;
        this.alpha -= 1.5;
      }
      display() {
        noStroke();
        fill(255, this.alpha);
        ellipse(this.pos.x, this.pos.y, this.size);
      }
      isDone() {
        return this.alpha <= 0;
      }
    }
  </script>
</body>
</html>
