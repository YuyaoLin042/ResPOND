<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ResPOND BLE Visualization</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: "Calibri";
      color: #ffffff;
      overflow: hidden;
      height: 100vh;
    }
    #container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    #sidebar {
      flex: 0 0 30%;
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-right: 3px solid #369e8e;
      padding: 20px;
      box-sizing: border-box;
    }
    #sidebar h1 {
      font-size: 36px;
      font-weight: bold;
      text-align: center;
      margin: 10px 0;
    }
    .authorName {
      font-size: 16px;
      margin-bottom: 20px;
    }
    .buttonBar {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 80%;
    }
    button {
      padding: 8px 14px;
      font-size: 12px;
      background: #1976d2;
      color: #ffffff;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background: #1565c0;
    }
    .infoText {
      font-size: 16px;
      margin-bottom: 5px;
      color: gray;
    }
    #main {
      flex: 1;
      background: #087a5e;
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
      background: #087a5e;
    }
  </style>
</head>
<body>
<div id="container">
  <div id="sidebar">
    <h1>ResPOND</h1>
    <p class="authorName">Yuyao Lin</p>
    <div class="buttonBar">
      <button id="bleButton">Connect Device</button>
      <button id="fullscreenButton">Fullscreen</button>
    </div>
    <p class="infoText">Connected points: <span id="pointsCount">0</span></p>
    <p class="infoText">Motor Trigger Count: <span id="motorCount">0</span></p>
  </div>
  <div id="main">
    <canvas id="pondCanvas"></canvas>
  </div>
</div>

<script>
const canvas = document.getElementById("pondCanvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth * 0.7;
canvas.height = window.innerHeight;

let waveValue = 0;
let fishValues = [0, 0, 0];
let lastFishValues = [0, 0, 0];
let vibration = 0;

const diffThreshold = 4.0;
const requiredFishTriggers = 2;
const vibrationThreshold = 20;
let triggerActive = false;
let lastTrigger = false;
let triggerCount = 0;

const fishPos = [
  {x: canvas.width * 0.3, y: canvas.height * 0.8},
  {x: canvas.width * 0.5, y: canvas.height * 0.8},
  {x: canvas.width * 0.7, y: canvas.height * 0.8}
];

let ripples = [];
let pellets = [];
let bubbles = [];

let waterY = canvas.height * 0.7;
let targetWaterY = waterY;
let wavePhase = 0;

// BLE setup
let bleDevice = null;
let bleCharacteristic = null;

const bleButton = document.getElementById("bleButton");
const fullscreenButton = document.getElementById("fullscreenButton");
const pointsCountSpan = document.getElementById("pointsCount");
const motorCountSpan = document.getElementById("motorCount");

bleButton.addEventListener("click", async () => {
  if (!bleDevice) {
    try {
      const device = await navigator.bluetooth.requestDevice({
        filters: [{ services: ['0000ffe0-0000-1000-8000-00805f9b34fb'] }]
      });
      bleDevice = device;
      const server = await device.gatt.connect();
      const service = await server.getPrimaryService('0000ffe0-0000-1000-8000-00805f9b34fb');
      bleCharacteristic = await service.getCharacteristic('0000ffe1-0000-1000-8000-00805f9b34fb');
      await bleCharacteristic.startNotifications();
      bleCharacteristic.addEventListener('characteristicvaluechanged', handleData);
      bleButton.textContent = "Disconnect Device";
    } catch (e) {
      alert("BLE 连接失败：" + e);
    }
  } else {
    if (bleDevice.gatt.connected) bleDevice.gatt.disconnect();
    bleDevice = null;
    bleCharacteristic = null;
    bleButton.textContent = "Connect Device";
  }
});

fullscreenButton.addEventListener("click", () => {
  if (!document.fullscreenElement) {
    canvas.requestFullscreen();
    fullscreenButton.textContent = "Exit Fullscreen";
  } else {
    document.exitFullscreen();
    fullscreenButton.textContent = "Fullscreen";
  }
});

function handleData(event) {
  const value = new TextDecoder().decode(event.target.value).trim();
  const parts = value.split(',');
  if (parts.length === 5) {
    waveValue = parseFloat(parts[0]);
    for (let i = 0; i < 3; i++) {
      fishValues[i] = parseFloat(parts[i+1]);

      if (Math.abs(fishValues[i] - lastFishValues[i]) > 0.5) {
        ripples.push({x: fishPos[i].x, y: fishPos[i].y, r: 5, alpha: 1.0});
      }
      lastFishValues[i] = fishValues[i];
    }

    vibration = parseFloat(parts[4]);

    let mismatch = 0;
    for (let i = 0; i < 3; i++) {
      if (Math.abs(fishValues[i] - waveValue) > diffThreshold) mismatch++;
    }

    const newTrigger = (mismatch >= requiredFishTriggers && vibration > vibrationThreshold);

    if (newTrigger && !lastTrigger) {
      for (let i = 0; i < 8; i++) {
        pellets.push({
          x: Math.random() * canvas.width,
          y: -20,
          speed: 2 + Math.random(),
          alpha: 1,
          hit: false
        });
      }
      triggerCount++;
    }

    lastTrigger = newTrigger;
    triggerActive = newTrigger;

    pointsCountSpan.textContent = fishValues.length;
    motorCountSpan.textContent = triggerCount;
  }
}

function drawFish(x, y) {
  ctx.strokeStyle = "rgba(255,255,255,0.7)";
  ctx.beginPath();
  ctx.moveTo(x - 20, y);
  ctx.bezierCurveTo(x - 10, y - 10, x + 10, y - 10, x + 20, y);
  ctx.bezierCurveTo(x + 10, y + 10, x - 10, y + 10, x - 20, y);
  ctx.moveTo(x - 20, y);
  ctx.lineTo(x - 30, y - 8);
  ctx.moveTo(x - 20, y);
  ctx.lineTo(x - 30, y + 8);
  ctx.stroke();
}

function animate() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  wavePhase += 0.03;
  waterY += (triggerActive ? -1 : 1) * 0.5;
  waterY = Math.max(canvas.height * 0.65, Math.min(canvas.height * 0.7, waterY));

  // Draw lake
  ctx.fillStyle = "#0c5a46";
  ctx.beginPath();
  for (let x = 0; x <= canvas.width; x += 10) {
    const y = waterY + 6 * Math.sin(0.015 * x + wavePhase);
    if (x === 0) ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.lineTo(0, canvas.height);
  ctx.closePath();
  ctx.fill();

  // Fish
  for (let i = 0; i < 3; i++) {
    const fishY = fishPos[i].y + 5 * Math.sin(performance.now() * 0.003 + i);
    drawFish(fishPos[i].x, fishY);
  }

  // Ripples
  for (let i = ripples.length - 1; i >= 0; i--) {
    const r = ripples[i];
    ctx.strokeStyle = `rgba(220,255,240,${r.alpha})`;
    ctx.beginPath();
    ctx.arc(r.x, r.y, r.r, 0, 2 * Math.PI);
    ctx.stroke();
    r.r += 1.5;
    r.alpha -= 0.015;
    if (r.alpha <= 0) ripples.splice(i, 1);
  }

  // Pellets
  for (let i = pellets.length - 1; i >= 0; i--) {
    const p = pellets[i];
    if (!p.hit) {
      p.y += p.speed;
      if (p.y >= waterY) {
        p.hit = true;
        for (let j = 0; j < 4; j++) {
          bubbles.push({
            x: p.x + Math.random() * 20 - 10,
            y: waterY,
            r: 4 + Math.random() * 6,
            speed: 0.5 + Math.random(),
            alpha: 1
          });
        }
      }
    } else {
      p.alpha -= 0.02;
    }
    ctx.fillStyle = `rgba(255,255,255,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x, p.y, 5, 0, 2 * Math.PI);
    ctx.fill();
    if (p.alpha <= 0) pellets.splice(i, 1);
  }

  // Bubbles
  for (let i = bubbles.length - 1; i >= 0; i--) {
    const b = bubbles[i];
    b.y -= b.speed;
    b.alpha -= 0.01;
    ctx.strokeStyle = `rgba(255,255,255,${b.alpha})`;
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, 2 * Math.PI);
    ctx.stroke();
    if (b.alpha <= 0) bubbles.splice(i, 1);
  }

  requestAnimationFrame(animate);
}

animate();
</script>
</body>
</html>
